ğŸ“Œ BÆ°á»›c 1: CÃ i Ä‘áº·t cÃ¡c package cáº§n thiáº¿t
TrÆ°á»›c tiÃªn, má»Ÿ terminal hoáº·c Package Manager Console vÃ  cháº¡y lá»‡nh sau Ä‘á»ƒ cÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t:

```powershell
dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer
dotnet add package Swashbuckle.AspNetCore
```
âœ… TÃ¡c dá»¥ng: 
- `Microsoft.AspNetCore.Authentication.JwtBearer` â Há»— trá»£ xÃ¡c thá»±c JWT trong ASP.NET Core.  
- `Swashbuckle.AspNetCore` â TÃ­ch há»£p Swagger Ä‘á»ƒ test API.

---

ğŸ“Œ BÆ°á»›c 2: Cáº¥u hÃ¬nh JWT trong `appsettings.json`
Má»Ÿ file `appsettings.json` vÃ  thÃªm cáº¥u hÃ¬nh JWT:

```json
{
  "JwtSettings": {
    "Secret": "your_super_secret_key_123456789", 
    "Issuer": "YourIssuer",
    "Audience": "YourAudience",
    "ExpireMinutes": 60
  }
}
```

âœ… **Giáº£i thÃ­ch:**  
- `Secret` â KhÃ³a bÃ­ máº­t Ä‘á»ƒ kÃ½ token (**nÃªn giá»¯ bÃ­ máº­t**).  
- `Issuer` â Äá»‹nh danh cá»§a server phÃ¡t hÃ nh token.  
- `Audience` â Äá»‘i tÆ°á»£ng sá»­ dá»¥ng token.  
- `ExpireMinutes` â Thá»i gian token háº¿t háº¡n.

---

ğŸ“Œ BÆ°á»›c 3: Táº¡o `JwtService` Ä‘á»ƒ sinh Token
Táº¡o thÆ° má»¥c `Services`, sau Ä‘Ã³ thÃªm file `JwtService.cs`:

```csharp
using Microsoft.Extensions.Configuration;
using Microsoft.IdentityModel.Tokens;
using System;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

public class JwtService
{
    private readonly IConfiguration _configuration;

    public JwtService(IConfiguration configuration)
    {
        _configuration = configuration;
    }

    public string GenerateToken(string username, string role)
    {
        var jwtSettings = _configuration.GetSection("JwtSettings");
        var key = Encoding.UTF8.GetBytes(jwtSettings["Secret"]);

        var tokenHandler = new JwtSecurityTokenHandler();
        var tokenDescriptor = new SecurityTokenDescriptor
        {
            Subject = new ClaimsIdentity(new[]
            {
                new Claim(ClaimTypes.Name, username),
                new Claim(ClaimTypes.Role, role)
            }),
            Expires = DateTime.UtcNow.AddMinutes(Convert.ToDouble(jwtSettings["ExpireMinutes"])),
            SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature),
            Issuer = jwtSettings["Issuer"],
            Audience = jwtSettings["Audience"]
        };

        var token = tokenHandler.CreateToken(tokenDescriptor);
        return tokenHandler.WriteToken(token);
    }
}
```

âœ… **Giáº£i thÃ­ch:**  
- **`GenerateToken`** â Táº¡o JWT token chá»©a `username` & `role`.  
- **`Claims`** â LÆ°u thÃ´ng tin user vÃ o token.  
- **`SigningCredentials`** â KÃ½ token vá»›i `HmacSha256`.  
- **`Expires`** â Háº¡n sá»­ dá»¥ng cá»§a token.  

---

# **ğŸ“Œ BÆ°á»›c 4: Cáº¥u hÃ¬nh Authentication & Authorization trong `Program.cs`**
Má»Ÿ `Program.cs` vÃ  thÃªm Ä‘oáº¡n code sau:

```csharp
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;
using System.Text;

var builder = WebApplication.CreateBuilder(args);

// Äá»c cáº¥u hÃ¬nh JWT tá»« appsettings.json
var jwtSettings = builder.Configuration.GetSection("JwtSettings");
var key = Encoding.UTF8.GetBytes(jwtSettings["Secret"]);

// Cáº¥u hÃ¬nh Authentication vá»›i JWT
builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.RequireHttpsMetadata = false;
    options.SaveToken = true;
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuerSigningKey = true,
        IssuerSigningKey = new SymmetricSecurityKey(key),
        ValidateIssuer = true,
        ValidIssuer = jwtSettings["Issuer"],
        ValidateAudience = true,
        ValidAudience = jwtSettings["Audience"],
        ValidateLifetime = true,
        ClockSkew = TimeSpan.Zero
    };
});

// Cáº¥u hÃ¬nh Authorization
builder.Services.AddAuthorization();

// ÄÄƒng kÃ½ JwtService
builder.Services.AddSingleton<JwtService>();

// Cáº¥u hÃ¬nh Swagger cÃ³ Authentication
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(options =>
{
    options.AddSecurityDefinition("Bearer", new Microsoft.OpenApi.Models.OpenApiSecurityScheme
    {
        Name = "Authorization",
        Type = Microsoft.OpenApi.Models.SecuritySchemeType.Http,
        Scheme = "Bearer",
        BearerFormat = "JWT",
        In = Microsoft.OpenApi.Models.ParameterLocation.Header,
        Description = "Nháº­p 'Bearer {token}' vÃ o Ã´ bÃªn dÆ°á»›i"
    });

    options.AddSecurityRequirement(new Microsoft.OpenApi.Models.OpenApiSecurityRequirement
    {
        {
            new Microsoft.OpenApi.Models.OpenApiSecurityScheme
            {
                Reference = new Microsoft.OpenApi.Models.OpenApiReference
                {
                    Type = Microsoft.OpenApi.Models.ReferenceType.SecurityScheme,
                    Id = "Bearer"
                }
            },
            new string[] {}
        }
    });
});

var app = builder.Build();

app.UseSwagger();
app.UseSwaggerUI();

app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

app.Run();
```

âœ… Giáº£i thÃ­ch:
- **Cáº¥u hÃ¬nh JWT Authentication** trong ASP.NET Core.  
- **ÄÄƒng kÃ½ `JwtService`** Ä‘á»ƒ sá»­ dá»¥ng trong Controller.  
- **TÃ­ch há»£p Swagger Security** Ä‘á»ƒ nháº­p Token.  

---

ğŸ“Œ BÆ°á»›c 5: Táº¡o API Ä‘Äƒng nháº­p Ä‘á»ƒ sinh JWT
Táº¡o file `AuthController.cs` trong thÆ° má»¥c `Controllers`:

```csharp
using Microsoft.AspNetCore.Mvc;

[Route("api/auth")]
[ApiController]
public class AuthController : ControllerBase
{
    private readonly JwtService _jwtService;

    public AuthController(JwtService jwtService)
    {
        _jwtService = jwtService;
    }

    [HttpPost("login")]
    public IActionResult Login([FromBody] LoginRequest request)
    {
        if (request.Username != "admin" || request.Password != "password")
            return Unauthorized("Invalid username or password");

        var token = _jwtService.GenerateToken(request.Username, "Admin");
        return Ok(new { Token = token });
    }
}

public class LoginRequest
{
    public string Username { get; set; }
    public string Password { get; set; }
}
```

âœ… **Giáº£i thÃ­ch:**  
- Nháº­n `username/password`, kiá»ƒm tra há»£p lá»‡ rá»“i sinh JWT token.  

---

# **ğŸ“Œ BÆ°á»›c 6: Ãp dá»¥ng Authorization vÃ o Controller**
Táº¡o file `SecureController.cs`:

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

[Route("api/secure")]
[ApiController]
public class SecureController : ControllerBase
{
    [Authorize]
    [HttpGet("protected")]
    public IActionResult GetProtectedData()
    {
        return Ok(new { Message = "This is a protected resource" });
    }

    [Authorize(Roles = "Admin")]
    [HttpGet("admin")]
    public IActionResult GetAdminData()
    {
        return Ok(new { Message = "This is an Admin-only resource" });
    }
}
```

âœ… **Giáº£i thÃ­ch:**  
- **`[Authorize]`** â Cháº·n truy cáº­p náº¿u khÃ´ng cÃ³ token.  
- **`[Authorize(Roles = "Admin")]`** â Chá»‰ `Admin` má»›i truy cáº­p Ä‘Æ°á»£c.  

---
---

# **ğŸ¯ Káº¿t luáº­n**
âœ… **Thiáº¿t láº­p JWT Authentication & Authorization**  
âœ… **Báº£o vá»‡ API báº±ng `[Authorize]`**  
âœ… **TÃ­ch há»£p Swagger Ä‘á»ƒ test API**  

ğŸš€ **Há»‡ thá»‘ng báº£o máº­t hoÃ n chá»‰nh!**


==================================================
                       *************Má» Rá»˜NG**************

1. HmacSha256 
- Trong code trÃªn cÃ³ thá»ƒ tháº¥y cÃ³ pháº§n 

SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)

- Tá»©c lÃ  kÃ½ token báº±ng HmacSha256. Pháº§n nÃ y cáº§n pháº£i hiá»ƒu cÃ¡c mÃ  token Ä‘Ã£ Ä‘Æ°á»£c táº¡o ra:

- Äáº§u tiá»n token Ä‘Æ°á»£c táº¡o ra cÃ³ 3 pháº§n chÃ­nh: Header.Payload.Signature vÃ  Ä‘Æ°á»£c gá»­i Ä‘i trong nhá»¯ng request vá» server.

Pháº§n Header chá»©a thÃ´ng tin: 
{
  "alg": "HS256", => Kiá»ƒu mÃ£ hÃ³a
  "typ": "JWT" => ÄÃ¢y lÃ  JWT Token
}
Cáº§n chuyá»ƒn thÃ´ng tin cá»§a Header thÃ nh token => Base64Url encode mÃ£ hÃ³a khÃ´ng báº£o máº­t.


Pháº§n Payload chá»©a thÃ´ng tin cÃ¡c claims Ä‘Æ°á»£c chÃºng ta thÃªm vÃ o:
{
  "sub": "1234567890",
  "name": "John Doe",
  "role": "Admin",
  "exp": 1693697200
}
Cáº§n chuyá»ƒn thÃ´ng tin cá»§a Payload thÃ nh token => Base64Url encode mÃ£ hÃ³a khÃ´ng báº£o máº­t.

==> Dá»±a vÃ o cÃ´ng thá»©c Header.Payload.Signature ta Ä‘Ã£ cÃ³ 2 pháº§n cá»§a token Ä‘Æ°á»£c mÃ£ hÃ³a nÃªn hiá»‡n táº¡i token sáº½ cÃ³ dáº¡ng: ey(v.v..)CJ9.eyJz(v.v..)AwfQ Ä‘Ã³ lÃ  (Header mÃ£ hÃ³a) + . + (Payload mÃ£ hÃ³a)

- Cuá»‘i cÃ¹ng chÃºng ta cáº§n táº¡o ra pháº§n cuá»‘i cá»§a token lÃ  Signature báº±ng cÃ´ng thá»©c: HMACSHA256( Base64(Header) + "." + Base64(Payload), SecretKey )

=> Cuá»‘i cÃ¹ng ghÃ©p 3 máº£nh láº¡i ngÄƒn cÃ¡ch báº±ng dáº¥u . thÃ¬ ra Ä‘Æ°á»£c token cuá»‘i cÃ¹ng. Header vÃ  Payload mÃ£ hÃ³a khÃ´ng báº£o máº­t nÃªn cáº§n Signature Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng HmacSha256 báº£o máº­t.

==> Káº¾T QUáº¢: Khi nháº­n Ä‘Æ°á»£c token thÃ¬ sáº½ chuyá»ƒn header vÃ  payload tá»« base64url vá» láº¡i thÃ´ng tin ban Ä‘áº§u. Tiáº¿p theo kiá»ƒm tra Signature báº±ng cÃ¡ch Ä‘Æ¡n giáº£n lÃ  dá»±a vÃ o Header, Payload Ä‘Æ°á»£c gá»­i tá»›i tá»« request vÃ  SecretKey trong há»‡ thá»‘ng táº¡o ra láº¡i 1 Signature thá»© 2 Ä‘á»ƒ so sÃ¡nh vá»›i Signature Ä‘Æ°á»£c gá»­i tá»›i tá»« request náº¿u trÃ¹ng nhau tá»©c lÃ  pháº§n SecretKey lÃ  trÃ¹ng nhau tá»« Ä‘Ã³ chá»©ng minh Ä‘Æ°á»£c Ä‘Ã³ chÃ­nh lÃ  1 token há»£p lá»‡.
