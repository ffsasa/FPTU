1ï¸âƒ£ Middleware lÃ  gÃ¬?
Middleware lÃ  cÃ¡c thÃ nh pháº§n trung gian xá»­ lÃ½ request trÆ°á»›c khi chÃºng Ä‘áº¿n Controller vÃ  sau khi nháº­n Ä‘Æ°á»£c response tá»« Controller.

ğŸ›  Chá»©c nÄƒng chÃ­nh cá»§a Middleware:

XÃ¡c thá»±c & á»¦y quyá»n (Authentication & Authorization)
Ghi log, Ä‘o thá»i gian xá»­ lÃ½ request
Xá»­ lÃ½ lá»—i (Exception Handling)
CORS (Cross-Origin Resource Sharing)
Compression (Gzip, Brotli)
Táº¡o cache, response header, redirect,...
ğŸ“Œ Chuá»—i Middleware hoáº¡t Ä‘á»™ng nhÆ° sau:

Client ---> Middleware 1 ---> Middleware 2 ---> Middleware 3 ---> Controller
Client <--- Middleware 1 <--- Middleware 2 <--- Middleware 3 <--- Response
ğŸ‘‰ Má»—i Middleware cÃ³ thá»ƒ:

Chuyá»ƒn tiáº¿p request Ä‘áº¿n Middleware tiáº¿p theo (await _next(context))
Cháº·n request (vÃ­ dá»¥: Unauthorized, BadRequest)
Chá»‰nh sá»­a request hoáº·c response
2ï¸âƒ£ CÃ¡ch Viáº¿t Middleware ÄÆ¡n Giáº£n
CÃ³ 3 cÃ¡ch Ä‘á»ƒ viáº¿t Middleware:
âœ… Sá»­ dá»¥ng delegate (cÃ¡ch Ä‘Æ¡n giáº£n nháº¥t)
âœ… Táº¡o class Middleware
âœ… DÃ¹ng extension method cho Middleware

ğŸ“Œ 2.1 Middleware Ä‘Æ¡n giáº£n báº±ng delegate
DÃ¹ng app.Use() Ä‘á»ƒ táº¡o Middleware ngay trong Program.cs.

var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Use(async (context, next) =>
{
    Console.WriteLine($"Request: {context.Request.Method} {context.Request.Path}");
    await next(); // Chuyá»ƒn tiáº¿p request Ä‘áº¿n Middleware tiáº¿p theo
    Console.WriteLine($"Response: {context.Response.StatusCode}");
});

app.MapGet("/", () => "Hello, Middleware!");
app.Run();
ğŸ‘‰ Khi cÃ³ request Ä‘áº¿n, Middleware nÃ y sáº½ log ra console trÆ°á»›c vÃ  sau khi Controller xá»­ lÃ½.

ğŸ“Œ 2.2 Viáº¿t Middleware báº±ng class
Khi Middleware phá»©c táº¡p hÆ¡n, báº¡n nÃªn táº¡o má»™t class riÃªng Ä‘á»ƒ dá»… quáº£n lÃ½.

BÆ°á»›c 1: Táº¡o Middleware
public class LoggingMiddleware
{
    private readonly RequestDelegate _next;

    public LoggingMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task Invoke(HttpContext context)
    {
        Console.WriteLine($"[LoggingMiddleware] Request: {context.Request.Method} {context.Request.Path}");
        
        await _next(context); // Chuyá»ƒn request Ä‘áº¿n Middleware tiáº¿p theo
        
        Console.WriteLine($"[LoggingMiddleware] Response: {context.Response.StatusCode}");
    }
}
BÆ°á»›c 2: ÄÄƒng kÃ½ Middleware trong Program.cs
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.UseMiddleware<LoggingMiddleware>(); // ThÃªm Middleware

app.MapGet("/", () => "Hello, Middleware!");
app.Run();
ğŸ‘‰ Khi cháº¡y, má»—i request Ä‘áº¿n server sáº½ Ä‘Æ°á»£c Middleware nÃ y log láº¡i.

ğŸ“Œ 2.3 Táº¡o Middleware báº±ng Extension Method
CÃ¡ch nÃ y giÃºp Middleware dá»… sá»­ dá»¥ng hÆ¡n mÃ  khÃ´ng cáº§n gá»i UseMiddleware<T>() trá»±c tiáº¿p.

BÆ°á»›c 1: Viáº¿t Middleware nhÆ° bÃ¬nh thÆ°á»ng
public class LoggingMiddleware
{
    private readonly RequestDelegate _next;

    public LoggingMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task Invoke(HttpContext context)
    {
        Console.WriteLine($"[LoggingMiddleware] Request: {context.Request.Method} {context.Request.Path}");
        await _next(context);
        Console.WriteLine($"[LoggingMiddleware] Response: {context.Response.StatusCode}");
    }
}
BÆ°á»›c 2: Táº¡o Extension Method
public static class MiddlewareExtensions
{
    public static IApplicationBuilder UseLoggingMiddleware(this IApplicationBuilder app)
    {
        return app.UseMiddleware<LoggingMiddleware>();
    }
}
BÆ°á»›c 3: ÄÄƒng kÃ½ trong Program.cs
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.UseLoggingMiddleware(); // DÃ¹ng extension method

app.MapGet("/", () => "Hello, Middleware!");
app.Run();
ğŸ‘‰ Dá»… Ä‘á»c hÆ¡n, dá»… tÃ¡i sá»­ dá»¥ng hÆ¡n trong dá»± Ã¡n lá»›n.

3ï¸âƒ£ Middleware Trong Dá»± Ãn Thá»±c Táº¿
Trong cÃ¡c dá»± Ã¡n thá»±c táº¿, há» KHÃ”NG viáº¿t má»›i Middleware hoÃ n toÃ n, mÃ :

TÃ¡i sá»­ dá»¥ng Middleware cÃ³ sáºµn tá»« ASP.NET Core (UseAuthorization, UseCors, UseExceptionHandler, UseAuthentication, v.v.).
Táº¡o Middleware riÃªng náº¿u cáº§n (vÃ­ dá»¥: Logging, Rate Limiting, Custom Error Handling).
Tinh chá»‰nh Middleware cÅ© thay vÃ¬ viáº¿t láº¡i tá»« Ä‘áº§u.
ğŸ“Œ VÃ­ dá»¥ vá» Middleware thá»±c táº¿:

1. Middleware kiá»ƒm tra Authentication
public class AuthenticationMiddleware
{
    private readonly RequestDelegate _next;

    public AuthenticationMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task Invoke(HttpContext context)
    {
        var user = context.User;
        if (user.Identity is { IsAuthenticated: false })
        {
            context.Response.StatusCode = 401;
            await context.Response.WriteAsync("Báº¡n chÆ°a Ä‘Äƒng nháº­p!");
            return;
        }

        await _next(context);
    }
}
ğŸ“Œ Sá»­ dá»¥ng trong Program.cs:

app.UseMiddleware<AuthenticationMiddleware>();
2. Middleware xá»­ lÃ½ lá»—i toÃ n cá»¥c
public class ExceptionHandlingMiddleware
{
    private readonly RequestDelegate _next;

    public ExceptionHandlingMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task Invoke(HttpContext context)
    {
        try
        {
            await _next(context);
        }
        catch (Exception ex)
        {
            context.Response.StatusCode = 500;
            await context.Response.WriteAsync($"Lá»—i há»‡ thá»‘ng: {ex.Message}");
        }
    }
}
ğŸ“Œ ÄÄƒng kÃ½ trong Program.cs:

app.UseMiddleware<ExceptionHandlingMiddleware>();
4ï¸âƒ£ TÃ³m Táº¯t
CÃ¡ch viáº¿t Middleware					Khi nÃ o dÃ¹ng
DÃ¹ng delegate (app.Use())				Middleware Ä‘Æ¡n giáº£n, Ã­t tÃ¡i sá»­ dá»¥ng
DÃ¹ng class Middleware (UseMiddleware<T>())		Middleware phá»©c táº¡p, cáº§n dá»… báº£o trÃ¬
DÃ¹ng Extension Method (UseLoggingMiddleware())		Middleware cáº§n tÃ¡i sá»­ dá»¥ng nhiá»u nÆ¡i
ğŸ“Œ Trong dá»± Ã¡n thá»±c táº¿, há» thÆ°á»ng tÃ¡i sá»­ dá»¥ng Middleware cÅ© rá»“i tinh chá»‰nh thay vÃ¬ viáº¿t láº¡i tá»« Ä‘áº§u.
ğŸ“Œ Middleware ráº¥t quan trá»ng trong ASP.NET Core vÃ¬ nÃ³ giÃºp tÃ¡ch biá»‡t logic xá»­ lÃ½ request khá»i Controller.

